// Generated by CoffeeScript 1.4.0
(function() {
  var app, vm;

  window.vm = vm = {};

  window.app = app = {};

  vm.push = function(n) {
    vm.ram[vm.ram[0]] = n;
    return vm.ram[0] += 1;
  };

  vm.pop = function() {
    return vm.ram[--vm.ram[0]];
  };

  vm.commandPush = function(segment, index) {
    var ram;
    ram = vm.ram;
    switch (segment) {
      case 'constant':
        return vm.push(index);
      default:
        throw 'segment not implemented';
    }
  };

  vm.commandPop = function(segment, index) {
    return 0;
  };

  vm.commandAdd = function() {
    vm.a[0] = vm.pop();
    vm.b[0] = vm.pop();
    vm.a[0] += vm.b[0];
    return vm.push(vm.a[0]);
  };

  vm.hasMoreCode = function() {
    return vm.currentLine < vm.code.length;
  };

  vm.step = function() {
    if (vm.hasMoreCode()) {
      return vm.evalLine();
    }
  };

  vm.evalLine = function() {
    var line, tokens;
    line = vm.code[vm.currentLine];
    tokens = line.split(' ');
    switch (tokens[0]) {
      case "push":
        vm.commandPush(tokens[1], tokens[2]);
        break;
      case "pop":
        vm.commandPop(tokens[1], tokens[2]);
        break;
      case "add":
        vm.commandAdd();
        break;
      default:
        throw "unknown command " + token[0];
    }
    return vm.currentLine += 1;
  };

  vm.stop = function() {
    return 0;
  };

  vm.reset = function() {
    var ramBuffer;
    vm.stop();
    ramBuffer = ArrayBuffer(1024);
    vm.ram = Int16Array(ramBuffer);
    vm.ram[0] = 256;
    vm.a = Int16Array(ArrayBuffer(2));
    return vm.b = Int16Array(ArrayBuffer(2));
  };

  app.init = function() {
    vm.reset();
    $('#step').click(app.step);
    $('#run').click(app.run);
    $('#stop').click(app.stop);
    $('#reset').click(app.reset);
    app.dom = {};
    app.dom.code = $('#code');
    app.dom.stack = $('#stack');
    app.dom.ram = $('#ram');
    app.started = false;
    app.codeEditable(true);
    return app.updateDebugGui();
  };

  app.updateDebugGui = function() {
    var index, value, _i, _len, _ref, _results;
    app.dom.ram.html("");
    app.dom.stack.html("");
    _ref = vm.ram;
    _results = [];
    for (index = _i = 0, _len = _ref.length; _i < _len; index = ++_i) {
      value = _ref[index];
      app.dom.ram.append("<p>" + index + ": " + value + "</p>");
      if ((256 <= index && index <= 2047)) {
        _results.push(app.dom.stack.append("<p>" + index + ": " + value + "</p>"));
      } else {
        _results.push(void 0);
      }
    }
    return _results;
  };

  app.codeEditable = function(b) {
    if (b) {
      return app.dom.code.removeClass('lockCode');
    } else {
      return app.dom.code.addClass('lockCode');
    }
  };

  app.step = function() {
    app.codeEditable(false);
    if (!app.started) {
      app.getCode();
      app.started = true;
      $('.currentLine').removeClass('currentLine');
      return app.code[vm.currentLine].addClass('currentLine');
    } else {
      if (vm.hasMoreCode()) {
        vm.step();
        $('.currentLine').removeClass('currentLine');
        if (vm.hasMoreCode()) {
          app.code[vm.currentLine].addClass('currentLine');
        }
      }
      return app.updateDebugGui();
    }
  };

  app.getCode = function() {
    vm.code = [];
    app.code = [];
    app.dom.code.find('p').each(function(index, elem) {
      var jElem;
      jElem = $(elem);
      app.code.push(jElem);
      return vm.code.push(jElem.text());
    });
    return vm.currentLine = 0;
  };

  app.run = function() {
    return 0;
  };

  app.stop = vm.stop;

  app.reset = function() {
    vm.reset();
    app.started = false;
    app.codeEditable(true);
    app.updateDebugGui();
    return $('.currentLine').removeClass('currentLine');
  };

  $(function() {
    return app.init();
  });

}).call(this);
